<?php
declare(strict_types=1);
require_once dirname( __DIR__) . '/bootstrap.php';

$start = $stop = microtime(true);

// Let's initialize a collider that biases to 16-bit seeds
$collider = new Collision16Bit();

// Let's ask for 256 distinct keypairs
$keypairs = $collider->createDistinctKeyPairs(256);

echo 'Keypairs generated!', PHP_EOL;

// Let's extract the public keys only:
$publicKeys = $collider->extractPublicKeys($keypairs);

// Now let's find a collision with our corpus of public keys:
$result = $collider->findSeedCollisions($publicKeys);

if (is_null($result)) {
    die('Utter failure');
}

echo 'FOUND IN ', $result->steps, ' STEPS!', PHP_EOL;
echo sodium_bin2hex($result->sk), PHP_EOL;
echo '  ->  ', PHP_EOL;
echo sodium_bin2hex($result->pk), PHP_EOL;
echo PHP_EOL;

$out = '';

foreach ($keypairs as $index => $kp) {
    [$sk, $pk] = $kp;
    $out .= sodium_bin2hex($sk) . "\t->\t" . sodium_bin2hex($pk) . "\n";
    if (hash_equals($result->pk, $pk)) {
        echo 'INPUT KEY AT INDEX ', $index, PHP_EOL;
        echo sodium_bin2hex($sk), PHP_EOL;
        echo '  ->  ', PHP_EOL;
        echo sodium_bin2hex($pk), PHP_EOL;
        $stop = microtime(true);
        echo "\nRuntime: " . number_format($stop - $start, 3) . " seconds.\n";

        // Let's do a linear search, for comparison:
        $start = microtime(true);
        $search = $collider->linearSearch($publicKeys);
        $stop = microtime(true);

        echo "\nLinear search: " . number_format($stop - $start, 3) . " seconds; {$search->steps} steps.\n";
        exit(1);
    }
}

echo str_repeat('-', 80), PHP_EOL;
echo 'If you are reading this, the collision discovered was an internal one, not matching our candidates.', PHP_EOL;
echo str_repeat('-', 80), PHP_EOL;

$stop = microtime(true);
echo "\nRuntime: " . number_format($stop - $start, 3) . " seconds.\n";

// Let's do a linear search, for comparison:
$start = microtime(true);
$search = $collider->linearSearch($publicKeys);
$stop = microtime(true);

echo "\nLinear search: " . number_format($stop - $start, 3) . " seconds; {$search->steps} steps.\n";
<?php
declare(strict_types=1);
require_once dirname( __DIR__) . '/bootstrap.php';

$start = $stop = microtime(true);

// Let's initialize a collider that biases to 32-bit seeds
$collider = new Collision32Bit();
$collider->setMaxSteps(1 << 26);

// Let's ask for 32768 distinct keypairs
$keypairs = $collider->createDistinctKeyPairs(1 << 15);

$stop = microtime(true);
echo 'Keypairs generated in ', number_format($stop - $start, 3), ' seconds!', PHP_EOL;
$start = microtime(true);

// Let's extract the public keys only:
$publicKeys = $collider->extractPublicKeys($keypairs);

// If we find a cycle with allowSelf disabled, we're never going to succeed at a batch attack
// That's the trouble with truncated PRFs. To work around this, we'll use the parallelism code
// to pick a new starting point.
$para = 0;
$steps = 0;
do {
    // Now let's find a collision with our corpus of public keys:
    $result = $collider->findSeedCollisions($publicKeys, $para, false);
    $steps += $result->steps;
    ++$para;
} while (!$result->found && $para < 8192);

if (!$result->found) {
    $stop = microtime(true);
    echo "\nRuntime: " . number_format($stop - $start, 3) . " seconds.\n";
    die('Failure: We found an internal collision, and failed to batch attack the public keys.');
}

echo 'FOUND IN ', $steps, ' STEPS!', PHP_EOL;
echo sodium_bin2hex($result->sk), PHP_EOL;
echo '  ->  ', PHP_EOL;
echo sodium_bin2hex($result->pk), PHP_EOL;
echo PHP_EOL;

$out = '';

foreach ($keypairs as $index => $kp) {
    [$sk, $pk] = $kp;
    $out .= sodium_bin2hex($sk) . "\t->\t" . sodium_bin2hex($pk) . "\n";
    if (hash_equals($result->pk, $pk)) {
        echo 'INPUT KEY AT INDEX ', $index, PHP_EOL;
        echo sodium_bin2hex($sk), PHP_EOL;
        echo '  ->  ', PHP_EOL;
        echo sodium_bin2hex($pk), PHP_EOL;
        $stop = microtime(true);
        echo "\nRuntime: " . number_format($stop - $start, 3) . " seconds.\n";
    }
}

// Let's do a linear search, for comparison:
$start = microtime(true);
$search = $collider->linearSearch($publicKeys);
$stop = microtime(true);

echo "\nLinear search: " . number_format($stop - $start, 3) . " seconds; {$search->steps} steps.\n";

echo sodium_bin2hex($search->sk), PHP_EOL;
echo '  ->  ', PHP_EOL;
echo sodium_bin2hex($search->pk), PHP_EOL;

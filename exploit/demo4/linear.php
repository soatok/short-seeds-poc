<?php
declare(strict_types=1);
require_once dirname( __DIR__) . '/bootstrap.php';

if (!file_exists(__DIR__ . '/public-keys.json')) {
    die('key pairs not initialized');
}
if ($argc < 2) {
    die('Argument 1 is required (number)');
}
$para = (int) $argv[1];

$collider = new Collision32Bit();
$publicKeys = [];
$hexPublicKeys = json_decode(file_get_contents(__DIR__ . '/public-keys.json'), true);
foreach ($hexPublicKeys as $hex) {
    $publicKeys []= sodium_hex2bin($hex);
}

// 2^32 / 2^7 = 2^25
$start = ($para << 25);
$result = $collider->linearSearch($publicKeys, $start);

if (is_null($result)) {
    // Signal a failure to GNU Parallel so it doesn't terminate
    exit(256);
}
if (!$result->found) {
    exit(128);
}

echo 'Linear Search - ', $result->steps, ' STEPS!', PHP_EOL;
echo sodium_bin2hex($result->sk), PHP_EOL;
echo '  ->  ', PHP_EOL;
echo sodium_bin2hex($result->pk), PHP_EOL;
echo PHP_EOL;
echo 'SEE FOR YOURSELF IN key-pairs.json!', PHP_EOL, PHP_EOL;
